generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Teacher {
  id             String   @id @default(uuid())
  lastName       String
  firstName      String
  patronymic     String?
  phone          String?
  individualRate      Int      @default(0) // тенге/час за индивидуальное занятие
  groupRate           Int      @default(0) // тенге/час за групповое занятие
  room                String?  // кабинет по умолчанию ("Каб.1", "Спортзал")
  specialization      String?  // "И" (интенсив), "А" (академ), etc.
  isMethodist         Boolean  @default(false)
  methodistWeeklyRate Int      @default(0) // недельная ставка методиста (5000₸)
  isActive            Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  groups        Group[]
  scheduleSlots ScheduleSlot[]
}

model Student {
  id          String   @id @default(uuid())
  lastName    String
  firstName   String
  patronymic  String?
  parentName  String?
  parentPhone String?
  hourlyRate  Int      @default(0) // стоимость часа для родителя (тенге)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  groupMembers  GroupMember[]
  scheduleSlots ScheduleSlot[]
  attendances   Attendance[]
}

model Group {
  id        String   @id @default(uuid())
  name      String // М0, М1, ГРМ1 и т.д.
  groupType String? // "ГРМ", "М0", "М1", "ГР Реч", "ОНР", "АФК", "ЛФК"
  teacherId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacher       Teacher        @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  members       GroupMember[]
  scheduleSlots ScheduleSlot[]
}

model GroupMember {
  id        String @id @default(uuid())
  groupId   String
  studentId String

  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
}

model ScheduleSlot {
  id            String @id @default(uuid())
  teacherId     String
  studentId     String? // для индивидуальных занятий
  groupId       String? // для групповых занятий
  dayOfWeek     Int // 1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб, 7=Вс
  startTime     String // "09:00"
  endTime       String // "10:00"
  weekStartDate  String // "2025-01-20" — понедельник недели
  lessonType     String // "INDIVIDUAL" | "GROUP"
  lessonCategory String? // "А", "И", "Тех", "СОПР", "Метод"
  room           String? // кабинет для этого занятия

  teacher     Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  student     Student?     @relation(fields: [studentId], references: [id], onDelete: SetNull)
  group       Group?       @relation(fields: [groupId], references: [id], onDelete: SetNull)
  attendances Attendance[]
}

model Attendance {
  id             String   @id @default(uuid())
  scheduleSlotId String
  studentId      String
  date           String // "2025-01-20"
  isPresent      Boolean  @default(false)
  markedAt       DateTime?

  scheduleSlot ScheduleSlot @relation(fields: [scheduleSlotId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([scheduleSlotId, studentId, date])
}
